<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <script src="https://unpkg.com/htmx.org"></script>
    <script>
        let ws;
        let heartbeatInterval;

        function setupWebSocket() {
            function connect() {
                fetch('/cgi/child/chat')
                    .then(response => response.json())
                    .then(data => {
                        const websocketUrl = data.websocket_url;
                        console.log("Connecting to WebSocket server at:", websocketUrl);

                        ws = new WebSocket(websocketUrl);

                        ws.onopen = function(event) {
                            console.log('WebSocket connection established.');
                            document.getElementById('serverResponse').innerText = 'Connection established.';
                            startHeartbeat();
                        };

                        ws.onmessage = function(event) {
                            const messages = document.getElementById('messages');
                            const message = document.createElement('div');
                            message.textContent = event.data;
                            messages.appendChild(message);
                        };

                        ws.onclose = function(event) {
                            console.log('WebSocket connection closed:', event.code, event.reason);
                            document.getElementById('serverResponse').innerText = 'Connection lost. Reconnecting...';
                            stopHeartbeat();
                            setTimeout(connect, 5000); 
                        };

                        ws.onerror = function(error) {
                            console.error('WebSocket error observed:', error);
                            document.getElementById('serverResponse').innerText = 'An error occurred. Please refresh the page.';
                        };
                    })
                    .catch(error => {
                        console.error('Error fetching WebSocket URL:', error);
                        document.getElementById('serverResponse').innerText = 'Failed to connect to the server.';
                    });
            }

            connect();
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('Sending message:', message);
                ws.send(message);
            } else {
                console.warn('WebSocket is not open. Unable to send message.');
            }
        }

        function startHeartbeat() {
            console.log('Starting heartbeat...');
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    console.log('Sending heartbeat');
                    ws.send('heartbeat');
                } else {
                    console.warn('WebSocket is not open. Stopping heartbeat.');
                    stopHeartbeat();
                }
            }, 5000); 
        }

        function stopHeartbeat() {
            console.log('Stopping heartbeat...');
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        window.onload = setupWebSocket;
    </script>
</head>
<body>
    <nav>
      <a href="chat.html" hx-get="chat.html" hx-target="#main" hx-swap="innerHTML">chat</a>
      <a href="learn.html" hx-get="learn.html" hx-target="#main" hx-swap="innerHTML">learn</a>
    </nav>
    <div id="main" hx-trigger="load" hx-get="chat.html" hx-swap="outerHTML">
    </div>
</body>
</html>